async (page) => {
const label = "__LABEL__";
const url = "__URL__";

await page.addInitScript(() => {
  try {
    localStorage.setItem("user", JSON.stringify({ id: 1, username: "user", role: 1, token: "test-token" }));
    localStorage.setItem("i18nextLng", "zh");
  } catch {}
});

try {
  await page.unroute(/.*\/api\/.*/);
} catch {}

await page.route(/.*\/api\/.*/, async (route) => {
  const req = route.request();
  const requestUrl = req.url();
  let pathname = requestUrl;
  try {
    pathname = new URL(requestUrl).pathname;
  } catch {}

  const headers = { "content-type": "application/json; charset=utf-8" };

  const now = Math.floor(Date.now() / 1000);

  const isPath = (s) =>
    pathname === s || pathname.startsWith(s) || requestUrl.includes(s);

  if (isPath("/api/status")) {
    await route.fulfill({
      status: 200,
      headers,
      body: JSON.stringify({
        success: true,
        data: {
          system_name: "Realm OI",
          logo: "/favicon.ico",
          footer_html: "",
          quota_per_unit: 500000,
          display_in_currency: false,
          quota_display_type: "USD",
          enable_drawing: false,
          enable_task: false,
          enable_data_export: false,
          chats: [],
          data_export_default_time: "7",
          default_collapse_sidebar: false,
          mj_notify_enabled: false,
          docs_link: "",
          HeaderNavModules: null,
          turnstile_check: false,
          user_agreement_enabled: false,
          privacy_policy_enabled: false,
        },
      }),
    });
    return;
  }

  if (isPath("/api/user/self")) {
    await route.fulfill({
      status: 200,
      headers,
      body: JSON.stringify({
        success: true,
        message: "",
        data: {
          id: 1,
          username: "user",
          display_name: "",
          email: "",
          quota: 10000,
          group: "default",
          status: 1,
          role: 1,
          used_quota: "0",
          request_count: 0,
          inviter_id: 0,
          aff_count: 0,
          aff_history_quota: "0",
          DeletedAt: null,
        },
      }),
    });
    return;
  }

  if (isPath("/api/log/self/stat")) {
    await route.fulfill({
      status: 200,
      headers,
      body: JSON.stringify({ success: true, message: "", data: { quota: 0, rpm: 0, tpm: 0 } }),
    });
    return;
  }

  if (isPath("/api/log/self")) {
    await route.fulfill({
      status: 200,
      headers,
      body: JSON.stringify({
        success: true,
        message: "",
        data: {
          items: [
            {
              id: 1,
              created_at: now - 60,
              token_name: "t",
              model_name: "gpt-4o-mini",
              group: "default",
              type: 2,
              prompt_tokens: 1,
              completion_tokens: 2,
              quota: 10,
              request_id: "req_1",
              other: "{}",
            },
          ],
          page: 1,
          page_size: 10,
          total: 1,
        },
      }),
    });
    return;
  }

  await route.fulfill({
    status: 200,
    headers,
    body: JSON.stringify({ success: true, message: "", data: null }),
  });
});

await page.goto(url, { waitUntil: "domcontentloaded" });
await page.waitForTimeout(1100);

await page.addStyleTag({
  content: `
    *, *::before, *::after { animation: none !important; transition: none !important; }
    .Toastify, .Toastify__toast-container { display: none !important; }
  `,
});

await page.evaluate(() => {
  const normalize = (s) => String(s || "").replace(/\s+/g, "");
  const scope = document.querySelector(".table-scroll-card") || document.body;

  const rangeInput = scope.querySelector(".semi-datepicker-range-input") || scope.querySelector(".semi-datepicker-range");
  if (rangeInput) {
    rangeInput.setAttribute("data-pw-target", "billing-date-range");
    const inputs = Array.from(rangeInput.querySelectorAll("input"));
    for (const i of inputs) {
      try { i.value = ""; } catch {}
      i.setAttribute("placeholder", "Placeholder");
    }
  }

  const tokenInput =
    scope.querySelector('input[placeholder*="令牌名称"]') ||
    scope.querySelector('input[placeholder*="token"]');
  const tokenWrap = tokenInput ? tokenInput.closest(".semi-input-wrapper") : null;
  if (tokenWrap && tokenInput) {
    tokenWrap.setAttribute("data-pw-target", "billing-token");
    tokenInput.value = "";
    tokenInput.setAttribute("placeholder", "Placeholder");
  }

  const select = scope.querySelector("form .semi-select");
  if (select) {
    select.setAttribute("data-pw-target", "billing-select");
    const txt =
      select.querySelector(".semi-select-selection-text") ||
      select.querySelector(".semi-select-selection-placeholder");
    if (txt) txt.textContent = "Option";
  }

  const btnQuery = Array.from(scope.querySelectorAll("button")).find(
    (el) => normalize(el.textContent) === normalize("查询"),
  );
  if (btnQuery) {
    btnQuery.setAttribute("data-pw-target", "billing-btn-query");
    const content = btnQuery.querySelector(".semi-button-content") || btnQuery;
    content.textContent = "Query";
  }

  const btnReset = Array.from(scope.querySelectorAll("button")).find(
    (el) => normalize(el.textContent) === normalize("重置"),
  );
  if (btnReset) {
    btnReset.setAttribute("data-pw-target", "billing-btn-reset");
    const content = btnReset.querySelector(".semi-button-content") || btnReset;
    content.textContent = "Reset";
  }

  const btnCols = Array.from(scope.querySelectorAll("button")).find(
    (el) => normalize(el.textContent) === normalize("列设置"),
  );
  if (btnCols) {
    btnCols.setAttribute("data-pw-target", "billing-btn-cols");
    const content = btnCols.querySelector(".semi-button-content") || btnCols;
    content.textContent = "Cols";
  }

  const th = scope.querySelector(".semi-table-thead th") || scope.querySelector("thead th");
  if (th) {
    th.setAttribute("data-pw-target", "billing-th");
    th.textContent = "Header";
  }
});

await page.addStyleTag({
  content: `
    [data-pw-target="billing-date-range"] { width: 360px !important; height: 32px !important; }
    [data-pw-target="billing-date-range"] input { height: 32px !important; line-height: 32px !important; }
    [data-pw-target="billing-token"] { width: 240px !important; height: 32px !important; }
    [data-pw-target="billing-token"] input { height: 32px !important; line-height: 32px !important; }
    [data-pw-target="billing-select"] { width: 160px !important; height: 32px !important; }
    [data-pw-target="billing-btn-query"] { width: 120px !important; height: 32px !important; justify-content: center !important; }
    [data-pw-target="billing-btn-reset"] { width: 120px !important; height: 32px !important; justify-content: center !important; }
    [data-pw-target="billing-btn-cols"] { width: 120px !important; height: 32px !important; justify-content: center !important; }
    [data-pw-target="billing-th"] { width: 220px !important; height: 44px !important; vertical-align: middle !important; }
  `,
});

await page.evaluate(async () => {
  if (!document.fonts || !document.fonts.ready) return;
  try { await document.fonts.ready; } catch {}
});
await page.waitForTimeout(200);

const targets = [
  ["billing_date_range", '[data-pw-target="billing-date-range"]'],
  ["billing_token", '[data-pw-target="billing-token"]'],
  ["billing_select", '[data-pw-target="billing-select"]'],
  ["billing_btn_query", '[data-pw-target="billing-btn-query"]'],
  ["billing_btn_reset", '[data-pw-target="billing-btn-reset"]'],
  ["billing_btn_cols", '[data-pw-target="billing-btn-cols"]'],
  ["billing_th", '[data-pw-target="billing-th"]'],
];

for (const [name, sel] of targets) {
  const loc = page.locator(sel).first();
  await loc.waitFor({ state: "visible", timeout: 15000 });
  await loc.scrollIntoViewIfNeeded();
  if (name === "billing_select" || name.startsWith("billing_btn_")) {
    const box = await loc.boundingBox();
    if (box) {
      const inset = 1;
      await page.screenshot({
        path: `${label}_${name}.png`,
        clip: {
          x: Math.round(box.x) + inset,
          y: Math.round(box.y) + inset,
          width: Math.max(1, Math.round(box.width) - inset * 2),
          height: Math.max(1, Math.round(box.height) - inset * 2),
        },
      });
      continue;
    }
  }
  await loc.screenshot({ path: `${label}_${name}.png` });
}

return { ok: true };
}