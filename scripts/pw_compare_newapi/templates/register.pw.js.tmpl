async (page) => {
const label = "__LABEL__";
const url = "__URL__";

// Stabilize new-api register: stub status API to avoid error banners/toasts.
if (label === "newapi") {
  await page.addInitScript(() => {
    try { localStorage.setItem("i18nextLng", "zh"); } catch {}
  });

  await page.route("**/api/status", async (route) => {
    await route.fulfill({
      status: 200,
      headers: { "content-type": "application/json; charset=utf-8" },
      body: JSON.stringify({ success: true, data: { system_name: "Realm OI", logo: "/favicon.ico", footer_html: "", quota_per_unit: 500000, display_in_currency: false, quota_display_type: "USD", enable_drawing: false, enable_task: false, enable_data_export: false, chats: [], data_export_default_time: "7", default_collapse_sidebar: false, mj_notify_enabled: false, docs_link: "", HeaderNavModules: null, turnstile_check: false, user_agreement_enabled: false, privacy_policy_enabled: false } }),
    });
  });
}

await page.goto(url, { waitUntil: 'domcontentloaded' });
await page.waitForTimeout(800);

await page.evaluate(() => {
  const el = document.activeElement;
  if (el && typeof el.blur === "function") el.blur();
});

await page.evaluate(() => {
  const normalize = (s) => String(s || "").replace(/\s+/g, "");
  const card = document.querySelector(".semi-card");
  const titleEl = card
    ? Array.from(
        card.querySelectorAll(
          ".semi-typography-h1, .semi-typography-h2, .semi-typography-h3, h1, h2, h3",
        ),
      ).find((el) => normalize(el.textContent) === normalize("注 册"))
    : null;
  if (titleEl) titleEl.setAttribute("data-pw-target", "register-title");

  const wrappers = card ? Array.from(card.querySelectorAll(".semi-input-wrapper")) : [];
  const usernameWrapper = wrappers[0] || null;
  const passwordWrapper = wrappers[1] || null;
  const password2Wrapper = wrappers[2] || null;
  const usernameInput = usernameWrapper ? usernameWrapper.querySelector("input") : null;
  const passwordInput = passwordWrapper ? passwordWrapper.querySelector("input") : null;
  const password2Input = password2Wrapper ? password2Wrapper.querySelector("input") : null;
  if (usernameInput) usernameInput.setAttribute("data-pw-target", "register-username-input");
  if (passwordInput) passwordInput.setAttribute("data-pw-target", "register-password-input");
  if (password2Input) password2Input.setAttribute("data-pw-target", "register-password2-input");

  const btnEl = card
    ? Array.from(card.querySelectorAll("button")).find(
        (el) => normalize(el.textContent) === normalize("注册"),
      )
    : null;
  if (btnEl) btnEl.setAttribute("data-pw-target", "register-submit");

  const loginEl = card
    ? Array.from(card.querySelectorAll("a")).find(
        (el) => normalize(el.textContent) === normalize("登录"),
      )
    : null;
  if (loginEl) loginEl.setAttribute("data-pw-target", "register-login-link");

  let footerEl = loginEl;
  while (footerEl && footerEl !== card) {
    const t = normalize(footerEl.textContent);
    if (t.includes(normalize("已有账户"))) {
      break;
    }
    footerEl = footerEl.parentElement;
  }
  if (footerEl && footerEl !== card) footerEl.setAttribute("data-pw-target", "register-footer");

  const shell = document.querySelector("div.relative.overflow-hidden");
  if (shell) shell.setAttribute("data-pw-target", "register-shell");
});

await page.addStyleTag({
  content: `
    *, *::before, *::after { animation: none !important; transition: none !important; }
    .semi-toast, .semi-toast-wrapper, .semi-notification, .semi-notification-list { display: none !important; }
    input:-webkit-autofill, textarea:-webkit-autofill, select:-webkit-autofill {
      box-shadow: 0 0 0px 1000px transparent inset !important;
      -webkit-text-fill-color: inherit !important;
      transition: background-color 9999s ease-in-out 0s !important;
    }
  `,
});

await page.evaluate(async () => {
  if (!document.fonts || !document.fonts.ready) return;
  try {
    await document.fonts.ready;
  } catch {}
});
await page.waitForTimeout(300);

// Ensure realmoi auth body class is applied (Next hydration)
if (label === "realmoi") {
  await page
    .waitForFunction(() => document.body.classList.contains("newapi-auth"), null, {
      timeout: 8000,
    })
    .catch(() => {});
}

await page.screenshot({ path: `${label}_register.png` });

const card = page.locator('.semi-card').first();
await card.waitFor({ state: 'visible', timeout: 15000 });
await card.scrollIntoViewIfNeeded();
await card.screenshot({ path: `${label}_register_card.png` });

const cardBox = await card.boundingBox();
if (cardBox) {
  const wTop = 64;
  const hTop = 64;
  const wBottom = 24;
  const hBottom = 24;
  const topInset = 1;
  await page.screenshot({
    path: `${label}_register_card_topleft.png`,
    clip: {
      x: cardBox.x,
      y: cardBox.y + topInset,
      width: wTop,
      height: hTop - topInset,
    },
  });
  await page.screenshot({
    path: `${label}_register_card_topright.png`,
    clip: {
      x: cardBox.x + cardBox.width - wTop,
      y: cardBox.y + topInset,
      width: wTop,
      height: hTop - topInset,
    },
  });
  await page.screenshot({
    path: `${label}_register_card_bottomleft.png`,
    clip: {
      x: cardBox.x,
      y: cardBox.y + cardBox.height - hBottom,
      width: wBottom,
      height: hBottom,
    },
  });
  await page.screenshot({
    path: `${label}_register_card_bottomright.png`,
    clip: {
      x: cardBox.x + cardBox.width - wBottom,
      y: cardBox.y + cardBox.height - hBottom,
      width: wBottom,
      height: hBottom,
    },
  });
}

const title = page.locator('[data-pw-target="register-title"]').first();
await title.waitFor({ state: 'visible', timeout: 15000 });
await title.screenshot({ path: `${label}_register_title.png`, timeout: 15000 });

const wrappers = card.locator('.semi-input-wrapper');
await wrappers.nth(0).screenshot({ path: `${label}_register_username_wrapper.png` });
await wrappers.nth(1).screenshot({ path: `${label}_register_password_wrapper.png` });
await wrappers.nth(2).screenshot({ path: `${label}_register_password2_wrapper.png` });

const btnSubmit = page.locator('[data-pw-target="register-submit"]').first();
await btnSubmit.screenshot({ path: `${label}_register_btn_submit.png`, timeout: 15000 });

const footer = page.locator('[data-pw-target="register-footer"]').first();
await footer.waitFor({ state: 'visible', timeout: 15000 });
await footer.screenshot({ path: `${label}_register_footer.png`, timeout: 15000 });

const dump = await page.evaluate(() => {
  const rectOf = (el) => {
    if (!el) return null;
    const r = el.getBoundingClientRect();
    return { x: r.x, y: r.y, width: r.width, height: r.height };
  };
  const styleOf = (el) => {
    if (!el) return null;
    const s = getComputedStyle(el);
    return {
      tag: el.tagName.toLowerCase(),
      className: el.className || "",
      text: (el.textContent || "").trim(),
      rect: rectOf(el),
      fontFamily: s.fontFamily,
      fontSize: s.fontSize,
      fontWeight: s.fontWeight,
      lineHeight: s.lineHeight,
      letterSpacing: s.letterSpacing,
      textRendering: s.textRendering,
      webkitFontSmoothing: s.getPropertyValue("-webkit-font-smoothing"),
      mozOsxFontSmoothing: s.getPropertyValue("-moz-osx-font-smoothing"),
      color: s.color,
      backgroundColor: s.backgroundColor,
      borderColor: s.borderColor,
      borderRadius: s.borderRadius,
      borderWidth: s.borderWidth,
      borderStyle: s.borderStyle,
      boxShadow: s.boxShadow,
      transform: s.transform,
      filter: s.filter,
      backdropFilter: s.backdropFilter,
      opacity: s.opacity,
      padding: s.padding,
      margin: s.margin,
      height: s.height,
      width: s.width,
      display: s.display,
    };
  };

  const card = document.querySelector(".semi-card");
  const bodyEl = document.body;
  const shellEl = document.querySelector('[data-pw-target="register-shell"]');
  const titleEl = document.querySelector('[data-pw-target="register-title"]');
  const btnEl = document.querySelector('[data-pw-target="register-submit"]');
  const footerEl = document.querySelector('[data-pw-target="register-footer"]');
  const loginLinkEl = document.querySelector('[data-pw-target="register-login-link"]');
  const usernameInput = document.querySelector('[data-pw-target="register-username-input"]');
  const passwordInput = document.querySelector('[data-pw-target="register-password-input"]');
  const password2Input = document.querySelector('[data-pw-target="register-password2-input"]');

  return {
    dpr: window.devicePixelRatio,
    userAgent: navigator.userAgent,
    body: styleOf(bodyEl),
    shell: styleOf(shellEl),
    card: styleOf(card),
    title: styleOf(titleEl),
    usernameInput: styleOf(usernameInput),
    passwordInput: styleOf(passwordInput),
    password2Input: styleOf(password2Input),
    submitButton: styleOf(btnEl),
    footer: styleOf(footerEl),
    loginLink: styleOf(loginLinkEl),
  };
});

return dump;
}